package main

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"
	"strings"

	"github.com/PuerkitoBio/goquery"
	"github.com/njosefbeck/ehonnavi-scraper/scraperutils"
)

// Book : struct for a book
type Book struct {
	Title string `json:"title"`
	URL   string `json:"url"`
	Age   string `json:"age"`
}

func getPage(age string, pageNum string, books map[string]Book) {
	url := buildURL(age, pageNum)

	res, err := http.Get(url)
	if err != nil {
		log.Fatal(err)
	}

	defer res.Body.Close()

	body, err := ioutil.ReadAll(res.Body)
	if err != nil {
		log.Fatal(err)
	}

	result, err := scraperutils.FromShiftJIS(string(body))
	if err != nil {
		log.Fatal(err)
	}

	doc, err := goquery.NewDocumentFromReader(strings.NewReader(result))
	if err != nil {
		log.Fatal(err)
	}

	doc.Find(".detailOneCol").Each(func(i int, s *goquery.Selection) {
		title := s.Find(".text h3 a").Text()
		href, _ := s.Find(".text h3 a").Attr("href")
		_, hasKey := books[href]
		if !hasKey {
			books[href] = Book{Title: title, URL: href, Age: age}
		}
	})
}

func buildURL(age string, pageNum string) string {
	const first = "https://www.ehonnavi.net/browse_all/list.asp?dp=&st=2&tk="
	const third = "&ano=&pg="
	return first + age + third + pageNum
}

func main() {
	books := map[string]Book{}

	pages := [][]string{
		{"00", "1"}, {"00", "2"}, {"00", "3"}, {"00", "4"},
		{"01", "1"}, {"01", "2"}, {"01", "3"}, {"01", "4"}, {"01", "5"}, {"01", "6"}, {"01", "7"},
		{"02", "1"}, {"02", "2"}, {"02", "3"}, {"02", "4"}, {"02", "5"}, {"02", "6"}, {"02", "7"}, {"02", "8"}, {"02", "9"}, {"02", "10"}, {"02", "11"},
		{"03", "1"}, {"03", "2"}, {"03", "3"}, {"03", "4"}, {"03", "5"}, {"03", "6"}, {"03", "7"}, {"03", "8"}, {"03", "9"}, {"03", "10"}, {"03", "11"}, {"03", "12"}, {"03", "13"}, {"03", "14"}, {"03", "15"}, {"03", "16"}, {"03", "17"}, {"03", "18"}, {"03", "19"}, {"03", "20"}, {"03", "21"}, {"03", "22"}, {"03", "23"}, {"03", "24"}, {"03", "25"}, {"03", "26"}, {"03", "27"}, {"03", "28"},
		{"04", "1"}, {"04", "2"}, {"04", "3"}, {"04", "4"}, {"04", "5"}, {"04", "6"}, {"04", "7"}, {"04", "8"}, {"04", "9"}, {"04", "10"}, {"04", "11"}, {"04", "12"}, {"04", "13"}, {"04", "14"}, {"04", "15"}, {"04", "16"}, {"04", "17"}, {"04", "18"}, {"04", "19"}, {"04", "20"}, {"04", "21"}, {"04", "22"}, {"04", "23"}, {"04", "24"}, {"04", "25"}, {"04", "26"}, {"04", "27"}, {"04", "28"}, {"04", "29"}, {"04", "30"}, {"04", "31"}, {"04", "32"}, {"04", "33"}, {"04", "34"},
		{"05", "1"}, {"05", "2"}, {"05", "3"}, {"05", "4"}, {"05", "5"}, {"05", "6"}, {"05", "7"}, {"05", "8"}, {"05", "9"}, {"05", "10"}, {"05", "11"}, {"05", "12"}, {"05", "13"}, {"05", "14"}, {"05", "15"}, {"05", "16"}, {"05", "17"}, {"05", "18"}, {"05", "19"}, {"05", "20"}, {"05", "21"}, {"05", "22"}, {"05", "23"}, {"05", "24"}, {"05", "25"}, {"05", "26"}, {"05", "27"}, {"05", "28"}, {"05", "29"}, {"05", "30"}, {"05", "31"}, {"05", "32"}, {"05", "33"}, {"05", "34"}, {"05", "35"}, {"05", "36"}, {"05", "37"},
		{"06", "1"}, {"06", "2"}, {"06", "3"}, {"06", "4"}, {"06", "5"}, {"06", "6"}, {"06", "7"}, {"06", "8"}, {"06", "9"}, {"06", "10"}, {"06", "11"}, {"06", "12"}, {"06", "13"}, {"06", "14"}, {"06", "15"}, {"06", "16"}, {"06", "17"}, {"06", "18"}, {"06", "19"}, {"06", "20"}, {"06", "21"}, {"06", "22"}, {"06", "23"}, {"06", "24"}, {"06", "25"}, {"06", "26"}, {"06", "27"}, {"06", "28"}, {"06", "29"}, {"06", "30"}, {"06", "31"}, {"06", "32"}, {"06", "33"},
		{"07", "1"}, {"07", "2"}, {"07", "3"}, {"07", "4"}, {"07", "5"}, {"07", "6"}, {"07", "7"}, {"07", "8"}, {"07", "9"}, {"07", "10"}, {"07", "11"}, {"07", "12"}, {"07", "13"}, {"07", "14"}, {"07", "15"}, {"07", "16"}, {"07", "17"}, {"07", "18"}, {"07", "19"}, {"07", "20"}, {"07", "21"},
		{"08", "1"}, {"08", "2"}, {"08", "3"}, {"08", "4"}, {"08", "5"}, {"08", "6"}, {"08", "7"}, {"08", "8"}, {"08", "9"}, {"08", "10"}, {"08", "11"}, {"08", "12"}, {"08", "13"}, {"08", "14"}, {"08", "15"}, {"08", "16"}, {"08", "17"}, {"08", "18"},
		{"09", "1"}, {"09", "2"}, {"09", "3"}, {"09", "4"}, {"09", "5"}, {"09", "6"}, {"09", "7"}, {"09", "8"}, {"09", "9"}, {"09", "10"}, {"09", "11"}, {"09", "12"},
		{"10", "1"}, {"10", "2"}, {"10", "3"}, {"10", "4"}, {"10", "5"}, {"10", "6"}, {"10", "7"}, {"10", "8"}, {"10", "9"}, {"10", "10"}, {"10", "11"},
		{"11", "1"}, {"11", "2"}, {"11", "3"}, {"11", "4"}, {"11", "5"}, {"11", "6"}, {"11", "7"}, {"11", "8"},
		{"12", "1"}, {"12", "2"}, {"12", "3"}, {"12", "4"}, {"12", "5"}, {"12", "6"}, {"12", "7"}, {"12", "8"}, {"12", "9"},
		{"19", "1"}, {"19", "2"}, {"19", "3"}, {"19", "4"}, {"19", "5"}, {"19", "6"}, {"19", "7"}, {"19", "8"}, {"19", "9"}, {"19", "10"}, {"19", "11"},
	}

	for _, page := range pages {
		age := page[0]
		pageNumber := page[1]
		getPage(age, pageNumber, books)
		fmt.Println("Added age", age, "books to JSON. JSON now has", len(books), "items.")
	}

	jsonData, err := json.Marshal(books)
	if err != nil {
		log.Fatal(err)
	}

	err = ioutil.WriteFile("books.json", jsonData, 0644)
	if err != nil {
		log.Fatal(err)
	}
}
